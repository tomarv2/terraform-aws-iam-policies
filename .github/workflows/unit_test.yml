name: Unit Tests

on:
  push:
    branches:
      - develop

jobs:
  build:

    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8]

    steps:
      - uses: actions/checkout@v2
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tfremote
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run terraform
        uses: hashicorp/setup-terraform@v1
        with:
         terraform_version: 0.14.7
         terraform_wrapper: false

      - name: Run terraform plan
        working-directory: example
        run: |
          # TF ENVIRONMENT
          cd base
          pwd
          tf -cloud aws plan -var-file ../test_data/test-managed-policy.tfvars
        env:
          # TF ENVIRONMENT
          TF_AWS_BUCKET: "${{ secrets.TF_NONPROD_AWS_BUCKET }}"
          TF_AWS_PROFILE: "${{ secrets.TF_AWS_PROFILE }}"
          TF_AWS_BUCKET_REGION: "${{ secrets.TF_AWS_BUCKET_REGION }}"
          # AWS CREDENTIALS
          AWS_ACCESS_KEY_ID: "${{ secrets.DEV_AWS_ACCESS_KEY_ID }}"
          AWS_SECRET_ACCESS_KEY: "${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}"
          AWS_SESSION_TOKEN: "${{ secrets.AWS_SESSION_TOKEN }}"
          AWS_SECURITY_TOKEN: "${{ secrets.AWS_SECURITY_TOKEN }}"

